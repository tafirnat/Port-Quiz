<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Port-Quiz ¬∑ 3 Level & Statistik</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            background: #000000;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .container {
            max-width: 900px;
            width: 100%;
            background: #1c1c1e;
            border-radius: 2rem;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.8), inset 0 1px 1px rgba(255,255,255,0.05);
        }
        h1 { color: #fff; font-weight: 600; font-size: 2rem; letter-spacing: -0.01em; margin-bottom: 0.2rem; }
        .sub { color: #98989e; font-size: 0.9rem; margin-bottom: 1.8rem; border-left: 3px solid #0a84ff; padding-left: 1rem; }

        /* Modus & Level Auswahl */
        .selector-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
            align-items: center;
        }
        .mode-selector, .level-selector {
            background: #2c2c2e;
            border-radius: 3rem;
            padding: 0.4rem;
            display: inline-flex;
            border: 1px solid #3a3a3c;
        }
        .mode-btn, .level-btn {
            background: transparent;
            border: none;
            padding: 0.5rem 1.4rem;
            border-radius: 2.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: #b0b0b6;
            cursor: pointer;
            transition: 0.15s;
        }
        .mode-btn.active, .level-btn.active {
            background: #0a84ff;
            color: #fff;
        }

        .quiz-panel {
            background: #2c2c2e;
            border-radius: 1.6rem;
            padding: 1.8rem;
            border: 1px solid #3a3a3c;
            margin-bottom: 2rem;
        }
        .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #98989e;
            letter-spacing: 0.02em;
            margin-bottom: 0.4rem;
        }
        .label span { color: #5e5e64; margin-left: 0.5rem; }
        .readonly-field {
            background: #3a3a3c;
            border: 1px solid #4a4a4e;
            border-radius: 1.2rem;
            padding: 0.9rem 1.4rem;
            color: #fff;
            font-size: 1.2rem;
            width: 100%;
            margin-bottom: 1.4rem;
        }
        .input-row {
            display: flex;
            gap: 0.8rem;
            align-items: center;
            margin-bottom: 1.8rem;
        }
        .input-row input {
            flex: 2;
            background: #3a3a3c;
            border: 1px solid #4a4a4e;
            border-radius: 1.2rem;
            padding: 0.9rem 1.2rem;
            color: #fff;
            font-size: 1rem;
            outline: none;
            transition: background 0.2s, border 0.2s;
        }
        .input-row input:focus { border-color: #0a84ff; }
        .protocol-group {
            flex: 1;
            display: flex;
            background: #3a3a3c;
            border-radius: 2rem;
            padding: 0.2rem;
            border: 1px solid #4a4a4e;
        }
        .protocol-group label {
            flex: 1;
            text-align: center;
            padding: 0.5rem 0;
            border-radius: 1.8rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: #b0b0b6;
            cursor: pointer;
            transition: 0.15s;
        }
        .protocol-group input { display: none; }
        .protocol-group input:checked + label { background: #0a84ff; color: #fff; }

        .btn-row {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            margin: 1.8rem 0 1rem;
        }
        .btn {
            background: #3a3a3c;
            border: 1px solid #4a4a4e;
            padding: 0.8rem 1.6rem;
            border-radius: 2.5rem;
            font-weight: 500;
            color: #fff;
            cursor: pointer;
            flex: 1 0 auto;
            transition: background 0.15s;
        }
        .btn-primary { background: #0a84ff; border-color: #0a84ff; }
        .btn-primary:active { background: #0063ce; }
        .btn:disabled { opacity: 0.4; pointer-events: none; }

        .solution-bar {
            background: #2c2c2e;
            border-radius: 1.2rem;
            padding: 1.2rem 1.5rem;
            display: flex;
            justify-content: space-between;
            border: 1px solid #3a3a3c;
            margin-top: 1rem;
        }
        .solution-item span:first-child { color: #8e8e93; font-size: 0.75rem; display: block; }
        .solution-item strong { color: #fff; font-size: 1.3rem; font-weight: 500; }

        .error-feedback {
            background: rgba(255, 69, 58, 0.15);
            border-left: 4px solid #ff453a;
            padding: 0.8rem 1.2rem;
            border-radius: 1rem;
            margin: 1rem 0 0.5rem;
            color: #ffb3aa;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .error-feedback strong {
            color: #fff;
            background: #ff453a;
            padding: 0.2rem 0.8rem;
            border-radius: 2rem;
            font-weight: 600;
            margin: 0 0.2rem;
        }

        .stats-section {
            background: #2c2c2e;
            border-radius: 1.6rem;
            padding: 1.5rem;
            border: 1px solid #3a3a3c;
        }
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
            color: #fff;
        }
        .stats-header h3 { font-weight: 500; font-size: 1.2rem; }
        .small-btn {
            background: #3a3a3c;
            border: 1px solid #5a5a5e;
            padding: 0.3rem 1rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            color: #fff;
            cursor: pointer;
        }
        .global-stats {
            display: flex;
            gap: 2rem;
            background: #1c1c1e;
            padding: 1rem 1.5rem;
            border-radius: 3rem;
            margin-bottom: 1.8rem;
            color: #fff;
        }
        .global-stats div span { color: #98989e; font-size: 0.8rem; margin-right: 0.3rem; }
        .stat-list {
            max-height: 220px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        .stat-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #1c1c1e;
            padding: 0.7rem 1rem;
            border-radius: 2.5rem;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
            color: #fff;
        }
        .stat-item .port-badge {
            background: #0a84ff;
            border-radius: 2rem;
            padding: 0.2rem 0.7rem;
            font-weight: 600;
            margin-right: 0.8rem;
        }
        .stat-item .right { color: #30d158; font-weight: 600; margin: 0 0.2rem; }
        .stat-item .wrong { color: #ff453a; font-weight: 600; margin: 0 0.2rem; }
        .stat-item .percent { color: #98989e; margin-left: 0.5rem; }
        .reset-single { background: none; border: none; color: #ff9f0a; font-size: 1.2rem; cursor: pointer; margin-left: 0.5rem; }

        .hint-note { color: #5e5e64; font-size: 0.7rem; margin-top: 1rem; text-align: right; }
    </style>
</head>
<body>
<div class="container">
    <h1>üß™ Port-Quiz</h1>
    <div class="sub">Lerne Ports & Dienste ¬∑ mit Statistik und Fehlerkorrektur</div>

    <!-- Modus-Auswahl (Port‚ÜíDienst / Dienst‚ÜíPort / Gemischt) -->
    <div class="selector-row">
        <div class="mode-selector">
            <button id="modePortToName" class="mode-btn active">üî¢ Port ‚Üí Dienst</button>
            <button id="modeNameToPort" class="mode-btn">üìÑ Dienst ‚Üí Port</button>
            <button id="modeMixed" class="mode-btn">üé≤ Gemischt</button>
        </div>
        <!-- Level-Auswahl (Anf√§nger / Fortgeschritten / Experte / Gemischt) -->
        <div class="level-selector">
            <button id="levelAnfaenger" class="level-btn active">üå± Anf√§nger</button>
            <button id="levelFortgeschritten" class="level-btn">üöÄ Fortgeschritten</button>
            <button id="levelExperte" class="level-btn">‚ö° Experte</button>
            <button id="levelMixed" class="level-btn">üé≤ Gemischt</button>
        </div>
    </div>

    <div class="quiz-panel">
        <div class="label">FRAGE <span id="modeHint"></span></div>
        <input type="text" id="displayField" class="readonly-field" readonly>

        <div class="label">DEINE ANTWORT</div>
        <div class="input-row">
            <input type="text" id="answerField" placeholder="..." autocomplete="off">
            <div class="protocol-group">
                <input type="radio" name="prot" id="tcp" value="TCP"><label for="tcp">TCP</label>
                <input type="radio" name="prot" id="udp" value="UDP"><label for="udp">UDP</label>
            </div>
        </div>

        <!-- Fehlermeldung (nur bei falscher Antwort) -->
        <div id="errorMessage" class="error-feedback" style="display: none;"></div>

        <div class="btn-row">
            <button id="newBtn" class="btn">üîÑ Neue Frage</button>
            <button id="checkBtn" class="btn btn-primary" disabled>‚úÖ Pr√ºfen</button>
            <button id="solutionBtn" class="btn" disabled>üîç L√∂sung</button>
        </div>

        <div class="solution-bar">
            <div class="solution-item"><span>PORT / DIENST</span><strong id="solPort">‚Äî</strong></div>
            <div class="solution-item"><span>PROTOKOLL</span><strong id="solProto">‚Äî</strong></div>
        </div>
    </div>

    <!-- Statistikbereich -->
    <div class="stats-section">
        <div class="stats-header">
            <h3>üìä Fragen-Statistik</h3>
            <div>
                <button id="resetGlobalBtn" class="small-btn" style="margin-right:0.5rem;">üóë Global</button>
                <button id="resetAllBtn" class="small-btn">üîÅ Alle</button>
            </div>
        </div>

        <div class="global-stats">
            <div><span>‚úÖ Richtig:</span> <span id="globalCorrect">0</span></div>
            <div><span>‚ùå Falsch:</span> <span id="globalWrong">0</span></div>
            <div><span>üìà Erfolg:</span> <span id="globalPercent">0%</span></div>
        </div>

        <div id="statListContainer" class="stat-list"></div>
        <div class="hint-note">‚úï Einzelstatistik zur√ºcksetzen ¬∑ bei Fehlern wird die richtige L√∂sung angezeigt</div>
    </div>
</div>

<script>
(function() {
    'use strict';

    // ----- ERWEITERTE PORT-BIBLIOTHEK mit 3 Leveln (Anf√§nger, Fortgeschritten, Experte) -----
    const portLib = [
        // === ANF√ÑNGER (Level 0) - Die wichtigsten, t√§glich genutzten Ports ===
        { port: '20', dienst: 'FTP (Datentransfer)', proto: 'TCP', level: 0 },
        { port: '21', dienst: 'FTP (Kontrolle)', proto: 'TCP', level: 0 },
        { port: '22', dienst: 'SSH', proto: 'TCP', level: 0 },
        { port: '23', dienst: 'Telnet', proto: 'TCP', level: 0 },
        { port: '25', dienst: 'SMTP', proto: 'TCP', level: 0 },
        { port: '53', dienst: 'DNS', proto: 'UDP', level: 0 },
        { port: '67', dienst: 'DHCP (Server)', proto: 'UDP', level: 0 },
        { port: '68', dienst: 'DHCP (Client)', proto: 'UDP', level: 0 },
        { port: '80', dienst: 'HTTP', proto: 'TCP', level: 0 },
        { port: '110', dienst: 'POP3', proto: 'TCP', level: 0 },
        { port: '123', dienst: 'NTP', proto: 'UDP', level: 0 },
        { port: '139', dienst: 'NetBIOS Session', proto: 'TCP', level: 0 },
        { port: '143', dienst: 'IMAP', proto: 'TCP', level: 0 },
        { port: '443', dienst: 'HTTPS', proto: 'TCP', level: 0 },
        { port: '445', dienst: 'SMB', proto: 'TCP', level: 0 },
        { port: '993', dienst: 'IMAPS', proto: 'TCP', level: 0 },
        { port: '995', dienst: 'POP3S', proto: 'TCP', level: 0 },
        { port: '3389', dienst: 'RDP', proto: 'TCP', level: 0 },

        // === FORTGESCHRITTEN (Level 1) - H√§ufig in Netzwerken und Server-Umgebungen ===
        { port: '69', dienst: 'TFTP', proto: 'UDP', level: 1 },
        { port: '88', dienst: 'Kerberos', proto: 'TCP', level: 1 },
        { port: '137', dienst: 'NetBIOS Name', proto: 'UDP', level: 1 },
        { port: '138', dienst: 'NetBIOS Datagram', proto: 'UDP', level: 1 },
        { port: '161', dienst: 'SNMP', proto: 'UDP', level: 1 },
        { port: '162', dienst: 'SNMP Trap', proto: 'UDP', level: 1 },
        { port: '389', dienst: 'LDAP', proto: 'TCP', level: 1 },
        { port: '465', dienst: 'SMTPS', proto: 'TCP', level: 1 },
        { port: '500', dienst: 'IPSec IKE', proto: 'UDP', level: 1 },
        { port: '514', dienst: 'Syslog', proto: 'UDP', level: 1 },
        { port: '587', dienst: 'SMTP Submission', proto: 'TCP', level: 1 },
        { port: '631', dienst: 'IPP (Cups)', proto: 'TCP', level: 1 },
        { port: '993', dienst: 'IMAPS', proto: 'TCP', level: 1 }, // doppelt aber okay
        { port: '995', dienst: 'POP3S', proto: 'TCP', level: 1 },
        { port: '1433', dienst: 'MSSQL', proto: 'TCP', level: 1 },
        { port: '3306', dienst: 'MySQL', proto: 'TCP', level: 1 },
        { port: '5432', dienst: 'PostgreSQL', proto: 'TCP', level: 1 },
        { port: '6379', dienst: 'Redis', proto: 'TCP', level: 1 },
        { port: '27017', dienst: 'MongoDB', proto: 'TCP', level: 1 },

        // === EXPERTE (Level 2) - Spezielle Protokolle, VPN, Authentifizierung, Legacy ===
        { port: '9', dienst: 'Discard', proto: 'UDP', level: 2 },
        { port: '17', dienst: 'QOTD', proto: 'TCP', level: 2 },
        { port: '19', dienst: 'CHARGEN', proto: 'UDP', level: 2 },
        { port: '37', dienst: 'Time', proto: 'UDP', level: 2 },
        { port: '43', dienst: 'WHOIS', proto: 'TCP', level: 2 },
        { port: '70', dienst: 'Gopher', proto: 'TCP', level: 2 },
        { port: '79', dienst: 'Finger', proto: 'TCP', level: 2 },
        { port: '115', dienst: 'SFTP', proto: 'TCP', level: 2 },
        { port: '119', dienst: 'NNTP', proto: 'TCP', level: 2 },
        { port: '194', dienst: 'IRC', proto: 'TCP', level: 2 },
        { port: '220', dienst: 'IMAP3', proto: 'TCP', level: 2 },
        { port: '389', dienst: 'LDAP', proto: 'TCP', level: 2 },
        { port: '636', dienst: 'LDAPS', proto: 'TCP', level: 2 },
        { port: '873', dienst: 'rsync', proto: 'TCP', level: 2 },
        { port: '1701', dienst: 'L2TP', proto: 'UDP', level: 2 },
        { port: '1723', dienst: 'PPTP', proto: 'TCP', level: 2 },
        { port: '1812', dienst: 'RADIUS Auth', proto: 'UDP', level: 2 },
        { port: '1813', dienst: 'RADIUS Accounting', proto: 'UDP', level: 2 },
        { port: '2049', dienst: 'NFS', proto: 'TCP', level: 2 },
        { port: '3128', dienst: 'Squid Proxy', proto: 'TCP', level: 2 },
        { port: '3260', dienst: 'iSCSI', proto: 'TCP', level: 2 },
        { port: '5000', dienst: 'UPnP', proto: 'TCP', level: 2 },
        { port: '5353', dienst: 'mDNS', proto: 'UDP', level: 2 },
        { port: '5355', dienst: 'LLMNR', proto: 'UDP', level: 2 },
        { port: '8080', dienst: 'HTTP-Alt', proto: 'TCP', level: 2 },
        { port: '8443', dienst: 'HTTPS-Alt', proto: 'TCP', level: 2 }
    ];

    // ----- Zustand -----
    let currentEntry = null;                // { port, dienst, proto, level }
    let currentMode = null;                 // true: port‚Üídienst, false: dienst‚Üíport
    let selectedMode = 'portToName';         // 'portToName', 'nameToPort', 'mixed'
    let selectedLevel = 'anfaenger';          // 'anfaenger', 'fortgeschritten', 'experte', 'mixed'
    let stats = {};                          // { "20": { asked, correct, wrong } }

    // ----- DOM-Elemente -----
    const $ = document.querySelector.bind(document);
    const displayField = $('#displayField');
    const answerField = $('#answerField');
    const tcpRadio = $('#tcp');
    const udpRadio = $('#udp');
    const modeHint = $('#modeHint');
    const errorDiv = $('#errorMessage');
    const newBtn = $('#newBtn');
    const checkBtn = $('#checkBtn');
    const solutionBtn = $('#solutionBtn');
    const solPort = $('#solPort');
    const solProto = $('#solProto');
    const globalCorrectSpan = $('#globalCorrect');
    const globalWrongSpan = $('#globalWrong');
    const globalPercentSpan = $('#globalPercent');
    const statListContainer = $('#statListContainer');
    const resetGlobalBtn = $('#resetGlobalBtn');
    const resetAllBtn = $('#resetAllBtn');

    // Modus-Buttons
    const modePortToName = $('#modePortToName');
    const modeNameToPort = $('#modeNameToPort');
    const modeMixed = $('#modeMixed');

    // Level-Buttons
    const levelAnfaenger = $('#levelAnfaenger');
    const levelFortgeschritten = $('#levelFortgeschritten');
    const levelExperte = $('#levelExperte');
    const levelMixed = $('#levelMixed');

    // ----- Hilfsfunktionen -----
    function resetRadioStyles() {
        document.querySelectorAll('.protocol-group label').forEach(l => {
            l.style.backgroundColor = '';
            l.style.color = '';
        });
    }

    function uncheckRadios() {
        tcpRadio.checked = false;
        udpRadio.checked = false;
    }

    // Zuf√§lligen Eintrag basierend auf Level-Auswahl
    function pickRandomEntryByLevel() {
        let filtered = [];
        if (selectedLevel === 'anfaenger') {
            filtered = portLib.filter(e => e.level === 0);
        } else if (selectedLevel === 'fortgeschritten') {
            filtered = portLib.filter(e => e.level === 1);
        } else if (selectedLevel === 'experte') {
            filtered = portLib.filter(e => e.level === 2);
        } else { // mixed
            filtered = portLib;
        }
        if (filtered.length === 0) filtered = portLib; // Fallback
        return filtered[Math.floor(Math.random() * filtered.length)];
    }

    function ensureStats(port) {
        if (!stats[port]) stats[port] = { asked: 0, correct: 0, wrong: 0 };
    }

    function calcGlobal() {
        let totalCorrect = 0, totalWrong = 0;
        Object.values(stats).forEach(s => {
            totalCorrect += s.correct;
            totalWrong += s.wrong;
        });
        return { totalCorrect, totalWrong };
    }

    // ----- Statistik-Ansicht aktualisieren -----
    function refreshStatsDisplay() {
        const { totalCorrect, totalWrong } = calcGlobal();
        const totalAsked = totalCorrect + totalWrong;
        const globalPercent = totalAsked === 0 ? 0 : Math.round((totalCorrect / totalAsked) * 100);
        globalCorrectSpan.textContent = totalCorrect;
        globalWrongSpan.textContent = totalWrong;
        globalPercentSpan.textContent = globalPercent + '%';

        let html = '';
        const sortedPorts = Object.keys(stats).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
        for (let port of sortedPorts) {
            const s = stats[port];
            if (s.asked === 0) continue;
            const percent = s.asked === 0 ? 0 : Math.round((s.correct / s.asked) * 100);
            const entry = portLib.find(e => e.port === port);
            const dienstKurz = entry ? entry.dienst.split(' ')[0] : '?';
            const levelText = entry ? ['üå±', 'üöÄ', '‚ö°'][entry.level] || '' : '';
            html += `<div class="stat-item">
                <div style="display:flex; align-items:center;">
                    <span class="port-badge">${port}</span>
                    <span style="color:#aaa;">${levelText} ${dienstKurz}</span>
                </div>
                <div>
                    <span class="right">‚úî${s.correct}</span> <span class="wrong">‚úò${s.wrong}</span>
                    <span class="percent">${percent}%</span>
                    <button class="reset-single" data-port="${port}" title="Einzelstatistik zur√ºcksetzen">‚úï</button>
                </div>
            </div>`;
        }
        if (sortedPorts.length === 0 || html === '') {
            html = '<div style="color:#5e5e64; text-align:center; padding:1rem;">Noch keine Fragen beantwortet.</div>';
        }
        statListContainer.innerHTML = html;

        document.querySelectorAll('.reset-single').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const port = btn.dataset.port;
                if (stats[port]) {
                    stats[port] = { asked: 0, correct: 0, wrong: 0 };
                    refreshStatsDisplay();
                }
            });
        });
    }

    // ----- Modus setzen (UI) -----
    function setActiveMode(mode) {
        [modePortToName, modeNameToPort, modeMixed].forEach(btn => btn.classList.remove('active'));
        if (mode === 'portToName') modePortToName.classList.add('active');
        if (mode === 'nameToPort') modeNameToPort.classList.add('active');
        if (mode === 'mixed') modeMixed.classList.add('active');
        selectedMode = mode;
    }

    function setActiveLevel(level) {
        [levelAnfaenger, levelFortgeschritten, levelExperte, levelMixed].forEach(btn => btn.classList.remove('active'));
        if (level === 'anfaenger') levelAnfaenger.classList.add('active');
        if (level === 'fortgeschritten') levelFortgeschritten.classList.add('active');
        if (level === 'experte') levelExperte.classList.add('active');
        if (level === 'mixed') levelMixed.classList.add('active');
        selectedLevel = level;
    }

    // ----- Neue Frage generieren -----
    function loadNewQuestion() {
        currentEntry = pickRandomEntryByLevel();

        // Modus basierend auf Auswahl
        if (selectedMode === 'portToName') {
            currentMode = true;  // port ‚Üí dienst
        } else if (selectedMode === 'nameToPort') {
            currentMode = false; // dienst ‚Üí port
        } else { // mixed
            currentMode = Math.random() < 0.5;
        }

        // Anzeigefeld f√ºllen
        if (currentMode) {
            displayField.value = currentEntry.port;
            modeHint.innerText = 'üî∏ gesucht: Dienstname';
            answerField.placeholder = 'z.B. SSH';
        } else {
            displayField.value = currentEntry.dienst;
            modeHint.innerText = 'üîπ gesucht: Portnummer';
            answerField.placeholder = 'z.B. 22';
        }

        // Eingabefeld zur√ºcksetzen
        answerField.value = '';
        answerField.style.backgroundColor = '#3a3a3c';
        answerField.style.borderColor = '#4a4a4e';
        answerField.style.color = '#fff';
        resetRadioStyles();
        uncheckRadios();
        showError(null);

        solPort.innerHTML = '‚Äî';
        solProto.innerHTML = '‚Äî';

        checkBtn.disabled = false;
        solutionBtn.disabled = false;
    }

    function showError(message) {
        if (message) {
            errorDiv.innerHTML = message;
            errorDiv.style.display = 'flex';
        } else {
            errorDiv.style.display = 'none';
        }
    }

    // ----- Antwort pr√ºfen -----
    function checkAnswer() {
        if (!currentEntry) return;

        const port = currentEntry.port;
        ensureStats(port);
        const stat = stats[port];

        const userAnswer = answerField.value.trim();
        const selectedProto = document.querySelector('input[name="prot"]:checked');

        const correctPort = currentEntry.port;
        const correctServiceFull = currentEntry.dienst;
        const correctServiceFirst = correctServiceFull.split(' ')[0];
        const correctProto = currentEntry.proto;

        let answerCorrect = false;
        if (currentMode) {
            answerCorrect = (userAnswer.localeCompare(correctServiceFirst, undefined, { sensitivity: 'base' }) === 0);
        } else {
            answerCorrect = (userAnswer === correctPort);
        }

        const protoCorrect = selectedProto ? (selectedProto.value === correctProto) : false;
        const overallCorrect = answerCorrect && protoCorrect;

        stat.asked += 1;
        if (overallCorrect) {
            stat.correct += 1;
            showError(null);
        } else {
            stat.wrong += 1;
            let correctAnswerText = '';
            if (currentMode) {
                correctAnswerText = `‚úÖ Richtig: ${correctServiceFirst} (${correctServiceFull}) ¬∑ Protokoll: ${correctProto}`;
            } else {
                correctAnswerText = `‚úÖ Richtiger Port: ${correctPort} ¬∑ Protokoll: ${correctProto}`;
            }
            showError(`‚ùå Falsch. ${correctAnswerText}`);
        }

        // Visuelles Feedback
        if (answerCorrect) {
            answerField.style.backgroundColor = '#30d158';
        } else {
            answerField.style.backgroundColor = '#ff453a';
        }
        answerField.style.color = '#fff';
        answerField.style.borderColor = 'transparent';

        resetRadioStyles();
        if (selectedProto) {
            const label = selectedProto.nextElementSibling;
            if (protoCorrect) {
                label.style.backgroundColor = '#30d158';
                label.style.color = '#fff';
            } else {
                label.style.backgroundColor = '#ff453a';
                label.style.color = '#fff';
            }
        }

        refreshStatsDisplay();
        checkBtn.disabled = true;
        solutionBtn.disabled = true;
    }

    // ----- L√∂sung anzeigen -----
    function showSolution() {
        if (!currentEntry) return;
        const port = currentEntry.port;
        const service = currentEntry.dienst;
        const proto = currentEntry.proto;
        const firstWord = service.split(' ')[0];

        if (currentMode) {
            solPort.innerHTML = `${firstWord} <span style="color:#98989e;">(von: ${service})</span>`;
        } else {
            solPort.innerHTML = port;
        }
        solProto.innerHTML = proto;

        let solutionText = '';
        if (currentMode) {
            solutionText = `‚úÖ L√∂sung: ${firstWord} (${service}) ¬∑ Protokoll: ${proto}`;
        } else {
            solutionText = `‚úÖ L√∂sung: Port ${port} ¬∑ Protokoll: ${proto}`;
        }
        showError(solutionText);

        checkBtn.disabled = true;
        solutionBtn.disabled = true;
    }

    function resetAllStats() {
        stats = {};
        refreshStatsDisplay();
        showError(null);
    }

    // ----- Event-Listener -----
    newBtn.addEventListener('click', () => loadNewQuestion());
    checkBtn.addEventListener('click', checkAnswer);
    solutionBtn.addEventListener('click', showSolution);

    // Modus-Buttons
    modePortToName.addEventListener('click', () => {
        setActiveMode('portToName');
        loadNewQuestion();
    });
    modeNameToPort.addEventListener('click', () => {
        setActiveMode('nameToPort');
        loadNewQuestion();
    });
    modeMixed.addEventListener('click', () => {
        setActiveMode('mixed');
        loadNewQuestion();
    });

    // Level-Buttons
    levelAnfaenger.addEventListener('click', () => {
        setActiveLevel('anfaenger');
        loadNewQuestion();
    });
    levelFortgeschritten.addEventListener('click', () => {
        setActiveLevel('fortgeschritten');
        loadNewQuestion();
    });
    levelExperte.addEventListener('click', () => {
        setActiveLevel('experte');
        loadNewQuestion();
    });
    levelMixed.addEventListener('click', () => {
        setActiveLevel('mixed');
        loadNewQuestion();
    });

    resetGlobalBtn.addEventListener('click', () => {
        if (confirm('Alle Statistiken wirklich zur√ºcksetzen?')) resetAllStats();
    });
    resetAllBtn.addEventListener('click', () => {
        if (confirm('Alle Fragen-Statistiken l√∂schen?')) resetAllStats();
    });

    // ----- Initialisierung -----
    (function init() {
        setActiveMode('portToName');
        setActiveLevel('anfaenger');
        loadNewQuestion();
        refreshStatsDisplay();
    })();
})();
</script>
</body>
</html>
